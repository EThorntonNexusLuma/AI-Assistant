<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Vapi Diagnostics — GitHub Pages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px;background:#0b1020;color:#e7ecff}
    .card{background:#121832;border:1px solid #26345a;border-radius:12px;padding:16px;margin-bottom:16px}
    .pill{padding:4px 8px;border-radius:10px;font-size:12px}
    .ok{background:#163d26;color:#9ff9c9;border:1px solid #2e8b57}
    .err{background:#471a1a;color:#ffb8b8;border:1px solid #a23535}
    button{background:#4a66ff;border:0;color:white;padding:10px 14px;border-radius:10px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    #log{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;background:#0e1426;border:1px solid #26345a;padding:12px;border-radius:8px;max-height:260px;overflow:auto;}
  </style>
  <script>
    (function(){
      var PREFERRED_LOCAL_URL = 'assets/vapi.js'; // relative for GitHub Pages
      var candidates = [];
      if (PREFERRED_LOCAL_URL) candidates.push(PREFERRED_LOCAL_URL);
      candidates = candidates.concat(['./vapi.js','vapi.js','./assets/vapi.js','../assets/vapi.js']);
      function loadOne(urls, cb){
        if(!urls.length) return cb(false, null, []);
        var tried = [];
        (function go(){
          if(!urls.length) return cb(false, null, tried);
          var u = urls.shift(); tried.push(u);
          var s = document.createElement('script');
          s.src = u; s.defer = true;
          s.onload = function(){ cb(true, u, tried); };
          s.onerror = function(){ go(); };
          document.head.appendChild(s);
        })();
      }
      window.__diagLoadVapi = function(){
        return new Promise(function(resolve){ loadOne([].concat(candidates), function(ok, from, tried){ resolve({ok, from, tried}); }); });
      };
    })();
  </script>
</head>
<body
  data-vapi-public-key="385ecf4c-99a4-4319-8b03-111c6c61abf9"
  data-vapi-assistant-id="900acf00-1429-4a76-92b2-93f0e4ffa109"
>
  <div class="card"><b>Vapi Diagnostics — GitHub Pages</b></div>
  <div class="card" id="results"></div>
  <div class="card">
    <button id="mic">Request Mic</button>
    <button id="start" disabled>Start Test</button>
    <button id="stop" disabled>Stop</button>
  </div>
  <div class="card"><div id="log"></div></div>

<script>
(function(){
  const logEl = document.getElementById('log');
  function log(...a){ console.log('[DIAG]', ...a); logEl.textContent += a.join(' ') + '\n'; }

  const PUBLIC_KEY = (document.body.dataset.vapiPublicKey || '').trim();
  const ASSISTANT_ID = (document.body.dataset.vapiAssistantId || '').trim();

  const results = document.getElementById('results');
  const micBtn = document.getElementById('mic');
  const startBtn = document.getElementById('start');
  const stopBtn = document.getElementById('stop');

  let vapi = null;

  function pill(ok, label){ const cls = ok ? 'ok' : 'err'; return `<span class="pill ${cls}">${label}</span>`; }

  async function checks(){
    const secure = location.protocol==='https:' || location.hostname==='localhost';
    const sdk = await window.__diagLoadVapi();
    const vapiPresent = !!(window.Vapi && typeof window.Vapi === 'function');
    results.innerHTML = [
      `Secure: ${pill(secure,'OK')}`,
      `Vapi load: ${sdk.ok ? '<span class="pill ok">Loaded '+sdk.from+'</span>' : '<span class="pill err">Failed ('+(sdk.tried||[]).join(', ')+')</span>'}`,
      `window.Vapi: ${pill(vapiPresent,'OK')}`,
      `Public Key: ${pill(!!PUBLIC_KEY,'OK')}`,
      `Assistant ID: ${pill(!!ASSISTANT_ID,'OK')}`
    ].join('<br>');
    if (secure && sdk.ok && vapiPresent) startBtn.disabled = false;
    log('SDK load:', JSON.stringify(sdk));
  }

  async function getMic(){
    try{
      await navigator.mediaDevices.getUserMedia({ audio:true });
      log('Mic permission granted');
    }catch(e){
      log('Mic permission denied:', e && e.message);
    }
  }
  micBtn.onclick = getMic;

  startBtn.onclick = async function(){
    if (!(window.Vapi && typeof window.Vapi==='function')) { log('Vapi missing'); return; }
    vapi = vapi || new window.Vapi(PUBLIC_KEY);
    vapi.on('call-start', ()=>{ log('call-start'); stopBtn.disabled=false; });
    vapi.on('call-end', ()=>{ log('call-end'); stopBtn.disabled=true; });
    vapi.on('error', (e)=> log('error:', JSON.stringify(e)));
    try { await vapi.start(ASSISTANT_ID); log('start resolved'); } catch(e){ log('start failed:', e && e.message); }
  };
  stopBtn.onclick = function(){ try{ vapi && vapi.stop && vapi.stop(); }catch{} };

  checks();
})();
</script>
</body>
</html>
